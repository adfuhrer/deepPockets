%==========================================================================
%                               Deep Pockets
%                            1: Parametrization
%                                April 2016                       
%--------------------------------------------------------------------------
%                              Adrian Fuhrer
%==========================================================================
FOLDER_NAME = strrep(mfilename('fullpath'),mfilename,'');
if ismac
    backslashes = strfind(FOLDER_NAME,'/');
elseif isunix
    backslashes = strfind(FOLDER_NAME,'/');
elseif ispc
    backslashes = strfind(FOLDER_NAME,'\');
else
    disp('Platform not supported')
end
FOLDER_NAME = FOLDER_NAME(1:backslashes(end-1));
cd(FOLDER_NAME)
addpath(genpath(FOLDER_NAME))
%==========================================================================
close all
clear
clc
%
%==========================================================================
% We set parameters for the process:
% ------------------------>!! PARAMETERS !!<-------------------------------
% GENERAL SETTINGS:
% -- In what folder is the data stored? Temporary data will be stored here
%       as well. It should be a local path.
%       In this folder, three subfolders will be created:
%           -    Temp: contains the data in the new 'packages' format, as
%                specified within this script (days, weeks, months)
%           -  Output: contains the data transformed to returns, culReturns,
%                z-scores of both and as raw data, grouped by years.
%           - homerun: contains the final datasets in the .mat format. They
%                will then be used in the network.
DATA_SAVE_PATH = '/Users/adrian/Deep Pockets/Matlab/Data';
% DATA_SAVE_PATH = % Set a second one that can be easily commented/uncomm.
% -- This is to control wether a .mat file of the set is stored in the
%       end (at any rate, the set will be available in the heap at the end)
STORE_DOT_MAT = true;
%--------------------------------------------------------------------------
% SPECIFYING FEATURES:
% -- How many individual sheets were downloaded form Datastream?
NR_DOWNLOADED_FILES = 154;
% -- When repackaging the time series, how many packages should be fit into
%    one Output Table?
PACKS_PER_OUTPUT_TABLE = 5000;
%       This is a trade-off: RAM-congestion vs. fewer files to create.

% -- What is the minimum trading days we require to be in a month?
%       This should be closely linked to the 'noDailyObs' value below.
minTradingDays = 19;
% -- How many trading days do we include in the monthly package?
%       Trading days are taken from the last day in the month towards the
%       first day of the month. So if the last trading day in February is
%       the 28th (Friday), then we take the 28th, 27th, 26th ... until we
%       have found 19 trading days. We thus loose some at the beginning.
%       --> Link this closely to the 'minTradingDays': Ideally, it is an
%       integer multiple of 'minTradingDays', so that we look at one or two
%       month on a daily basis. If this is not the case, all the days after
%       'minTradingDays' are taken from a new month (23: 19 in the first
%       month, 4 in the second (although there might be more than 19 in the
%       first month..)
noDailyObs = 19;
% -- How many weekly observations do we include in the monthly package?
%       A month is assumed to have exactly 4 weekly observations.
noWeeklyObs = 8;
% -- How many monthly observations do we include in the monthly package?
%       A monthly Obs is ALWAYS the last trading day in the month. So any
%       left over days or weeks prohibit this month from being a monthly
%       Obs.
noMonthlyObs = 9;
% -- What point in the future do we take as a reference?
%       futureUnit is one of 'd', 'w', 'm'. It is the unit, either daily,
%       weekly or monthly of the point of reference.
%       futureStep is the number of Units the point lies in the future.
futureUnit = 'm';
futureStep = 1;
% -- What is the price-threshold, at which the data is ignored? In USD.
minPrice = 2;
% -- What are the maximally allowed price-swings within months? In 100%.
maxGR = 2;
% -- How many traiding-days with no movement are allowed within a month?
maxNonVariationDays = 5;
%--------------------------------------------------------------------------
% SPECIFYING THE TEST SET:
% -- In this case, we just use a time-cutoff: Everything before
%    'cutoffYear' goes into the training, everything after into the test 
%    set.

% I allow to specify a 'stretch' that is required, that is a number of
% consecutive month in the recent history for securities to be viable for
% testing the Network. The stretch is characterized by its length and the
% date it ends.
requiredLengthOfStretch = 12*10;
requiredMinimalEndDateOfStretch = 736697; %01.01.2017
testSetSize = 200;
nrRandomSets = 5;
% SPI:
chosenSet1=[7047;5354;119957;119956;16814;119955;112089;34608;119953;119948;119947;10469;8345;34378;119946;149;34379;87666;26363;119944;7401;11595;26364;114407;119942;119941;114408;34491;114411;7675;119940;119939;114409;119938;6180;11695;34492;114410;156;119981;119937;5042;4065;11871;5744;119932;26367;119931;119930;114412;119923;119785;13704;119927;11054;26368;119989;87546;6774;87549;87552;6723;7100;26371;119915;87561;119988;119204;34493;119912;11917;7071;119910;34494;26372;119834;7715;114413;119907;119906;114415;34610;119904;34380;119903;26374;7979;87933;34495;119900;115146;34612;119898;17294;119986;119756;6758;119924;11077;6132;114416;26378;13678;114406;8040;8042;114417;119840;26379;26380;114418;119909;119207;3374;10484;119893;34613;119819;10864;119985;8104;194;119888;119975;26383;17006;34381;26384;119886;119885;119884;12417;114419;34614;6167;119883;34615;87755;26386;200;119877;6647;119874;26389;26388;26396;119872;119838;119871;114421;3871;34496;119743;87834;119869;13821;12372;34616;11570;119740;87835;119867;119983;13720;119866;26393;119864;26398;16762;13915;26399;119860;119816;119858;114422;119856;5055;5054;119736;114424;8378;114423;26376;119855;87585;10993;11819;11894;26400;114425;34617;119628;114426;119853;119850;6971;114427;119849;34618;26401;119848];
% MSCI World :
chosenSet2=[25149;25383;10777;16395;177;25927;91759;26229;25848;25640;88902;25653;88901;198;8104;16397;197;89604;26211;186;29178;25890;25713;194;25328;25208;25721;200;34402;26222;25908;24230;26196;26053;2228;25609;25411;151;24905;26247;16376;16380;184;16403;14909;26534;22851;25981;94079;25669;16412;16408;88595;173;7087;202;26551;25601;26202;161;163;172;26678;158;11608;25891;26195;26192;22634;25748;26581;89907;20084;25455;25501;24316;169;34469;26220;83571;26298;148;14829;26022;87398;26168;8164;3372;26172;26418;155;10853;24936;25953;25771;29177;34346;22880;25780;25613;24337;7238;25957;25099;11903;22734;11274;159;26062;25612;7080;14606;24370;25723;10624;8179;26021;25122;16404;96419;11147;25694;83625;16025;25777;5168;114422;25405;24234;34392;26432;206;7068;24274;26093;20128;96178;16209;34390;25043;17898;14587;20255;25655;16191;34400;85062;11887;25847;26133;25990;25817;21406;26417;95706;25767;89051;25936;89715;24228;26316;25688;25836;24409;25643;95292;25745;25020;16676;26087;24971;24368;25586;25267;20583;20341;25622;13949;26294;7047;24359;26026;25901;24360;11466;22825;25571;26401;93602;8653;26398;26554;25926;25151;8135;25660;25662;104;25793;16296;4065;25710;6197;25971;21;52;95408;92843;20274;22631;26307;25253;14902;24459;90581;26504;8157;16043;26431;26024;26341;11386;14119;24911;17717;93257;17065;20083;25982;24438;26069;214;13859;25809;95718;24505;26054;21777;20123;87540;25782;24564;26612;25611;25784;87201;19780;29189;27910;16093;34408;15623;89917;34342;7;90902;25898;16077;25623;26141;25339;87731;24925;25112;94947;26651;11284;24420;25894;20218;24485;26368;11181;26589;24232;88834;25587;8361;26150;20385;24574;154;25754;11559;87835;8403;25464;25970;91154;25589;25740;96611;64;20653;27928;13660;25736;8400;17868;27686;66;26067;8398;95659;25119;27682;29176;94042;91640;34;92758;8125;25689;25258;2135;149;2178;21393;26116;8291;25785;25819;26378;10872;8501;25282;24885;25620;89397;24599;17867;26068;137;157;25993;16661;24888;93070;24422;26121;26246;87;25747;20370;24433;21730;24390;87536;25415;25964;19990;13615;11964;25735;21112;24329;34461;25802;26077;26234;26544;24451;25320;11385;87810;11080;26595;26355;71;29182;14232;20205;218;26243;10037;20310;26323;24431;20266;10905;34454;84541;89861;10546;6089;24525;87754;6879;20014;26354;89062;25273;34387;25906;26047;26433;25912;20411;24414;87651;11342;11712;17078;25934;26039;14604;87404;20946;15515;138;25787;26361;16151;13243;87872;25424;26030;2187;16230;26328;26096;26322;8155;26004;84693;90474;191;8414;8316;25077;26090;10532;29238;25353;20612;25878;25401;26226;10844;26002;90701;26344;14779;8147;25808;112767;16146;24997;34389;95629;25775;24460;26335;9213;7041;25679;25492;92100;25522;21814;21867;85626;55;87580;11140;25517;25357;17043;5188;25050;25164;22654;25618;26345;34388;91131;24428;8091;11415;11396;93989;13538;26372;34401;25200;6578;14522;20314;17796;13134;20574;24506;106509;16343;25951;20580;8136;87881;34479;22008;95898;24341;25839;34397;26250;26215;2216;34467;22651;34494;16177;25380;92046;24509;20211;113447;26531;89658;116;8159;25800;26606;8409;16526;25361;25110;25311;8546;25803;3844;24321;92762;104662;95908;84773;26212;16180;24481;25570;95544;19714;87449;8618;24454;26513;205;34457;84848;25942;25271;92339;25243;26343;88864;93065;96336;26241;26001;17008;25851;96273;91992;2161;91064;25305;187;25248;168;25349;96235;24376;20392;20172;166;25876;26625;95223;9635;11332;89056;9219;26084;25826;83600;34607;22058;25798;10557;25026;11402;24385;25700;16386;11005;93323;8396;13982;85731;22695;29190;25610;20460;22658;25963;20502;25973;88769;34758;26169;24426;26474;25315;27905;25633;8526;25070;17883;25202;11128;24495;25367;7055;10692;22884;6776;6675;2177;26097;24519;25210;25726;25769;25720;17025;2217;8622;87459;13150;20423;25856;34450;104492;26260;8172;20173;25651;34496;11551;90204;25431;20129;34464;15370;21014;13971;26007;167;8395;8162;25781;95814;94267;3871;106521;4891;4842;26396;10635;11250;8174;11672;10968;34458;25394;5354;91020;26201;17102;26324;104203;11373;26198;25974;15200;7228;25751;11079;96462;22863;8639;34437;8133;11211;11187;3545;13519;25879;34727;88797;89121;25696;25520;8149;104053;2233;87666;24528;25;22882;4088;90164;16371;17372;20067;11344;24365;16170;8646;24387;20333;26380;26006;22746;24995;11951;25595;26358;14831;13093;5055;119220;15904;25673;3909;17919;34394;25266;93597;24229;13525;25680;92979;25873;26443;11603;25309;91834;85652;13815;11858;21973;8127;24439;11349;10547;24447;87834;88889;91740;34440;11394;24567;10548;143;25909;3834;20047;8305;20044;20012;25947;25914;24442;15524;8510;34415;25346;14884;25806;20632;24540;34395;114253;20119;119774;24268;25581;25738;25730;25929;115564;14800;19974;92203;26287;16392;11149;34453;15250;10046;24326;88831;3927;21859;29181;25146;91863;17151;26110;20562;185;34383;24423;26584;34429;25861;93791;34483;25683;4018;195;26115;3569;5982;91242;24984;88745;104078;25670;24991;34386;109;3212;114419;17167;26058;7456;91110;22243;85067;26524;34499;216;20477;87566;34455;25753;8617;4081;9014;104108;25604;25978;22337;33666;29188;24338;26045;27891;26178;104534;95068;16179;210;90177;22675;25106;25056;7444;90457;33652;208;95772;92245;83621;85066;94445;96391;19992;112;26667;91605;90176;26162;25949;29183;26481;88843;26207;24327;25114;96632;34448;95950;8637;25096;14097;93963;93453;34463;82;89908;24594;11478;94360;20171;84766;85190;11011;8610;26348;91845;34468;17811;20237;27680;21691;21538;34399;23690;20147;25549;87630;87845;24371;21299;26388;26313;22162;13979;24516;29185;20283;24457;6884;114231;25034;34391;25833;25874;34484;10524;117;27900;84272;26295;25834;22303;11626;20613;8630;26232;24496;17294;22687;90602;25052;6281;27940;25722;25397;85714;26255;25637;26350;95939;5165;13328;34605;24907;165;90015;24517;16181;16663;24314;88840;20135;24987;25585;27906;87586;24958;14394;25073;15811;88732;34396;21330;25085;8612;21348;26036;8035;89903;87675;22879;25645;83572;25057;8314;24861;96649;96325;19735;87847;25484;3336;22818;13821;94062;11417;22888;26676;15189;25921;85688;5335;87622;26079;25066;24319;22796;24478;94545;17047;8408;24357;25987;26301;8619;20442;20059;5330;87705;6279;87893;26525;87460;95266;14671;87549;16847;17922;91102;22766;84623;22291;25946;87605;13870;24532;26419;29187;204;22760;20066;8040;25171;68;26363;229;10878;26546;88761;10550;34737;29180;26244;114230;22298;24890;24511;34398;12825;20148;34375;97;34470;27903;237;25832;26539;5357;27898;20402;89439;17914;15329;20919;34616;22745;34447;34516;2193;34480;10942;34414;26440;95964;24468;26291;17872;85483;25428;21765;21775;92243;90;6182;24492;93970;17373;24434;26356;11156;24464;6319;94019;22054;34706;93809;20049;54;85060;20496;21342;23851;21787;13809;91;20844;17066;24508;24526;16056;8042;6266;16346;4;87556;4247;14640;33694;22145;24582;84749;92098;24499;104296;24931;8381;203;26176;24529;2226;16651;25042;34714;15681;21451;27892;24523;34353;25783;22722;13455;119197;21350;16158;22859;20378;115580;27894;24396;17049;20530;17030;87592;93492;7067;26299;21408;24416;22755;15901;12039;34478;20717;84969;16542;24498;24487;22842;25064;84646;24325;21341;20122;10835;26445;6837;8348;87885;106577;91944;27914;87767;25103;10433;84982;34466;3628;16689;24307;22124;94562;7060;22203;84819;84846;20892;21576;6359;7998;22829;104468;85057;22330;3553;24309;16152;5063;84687;24894;2166;24476;124;26508;104612;16385;11474;25092;26371;21974;22771;188;21581;16198;3743;94842;22249;23852;8075;21766;3086;85670;15782;62;3824;87746;22850;34471;21409;104533;87585;24584;120004;4348;27630;25871;8057;15103;9404;2155;26635;21578;19986;20053;11060;24340;26488;33679;29179;20794;85058;84729;13533;98;10608;8329;20708;22864;13516;17168;11524;8175;13207;33;2157;16242;90769;24970;123771;20284;20088;31;2219;14724;24388;104127;87742;106;21476;24362;21541;87809;34345;26429;85061;8320;20030;21729;24151;25011;87841;25588;20092;34518;17024;14579;34410;21441;85010;21318;20405;20470;182;16768;20451;15521;20163;25841;26389;25423;3183;15419;22056;22349;85063;10704;16133;87515;20045;17380;21577;21360;22038;89129;14889;15190;87445;11071;10668;26653;29184;24507;34411;20490;119238;87628;2144;119225;11136;125;20995;87833;85288;17390;22870;26424;26434;123805;34433;3190;8223;15601;16128;21056;3202;85064;20199;84644;22218;22856;24979;21712;20159;34419;115634;10906;87545;84606;174;24484;21344;13875;26309;21971;8081;20270;20595;21410;119228;5054;106670;8052;26357;104497;26472;84231;84004;20290;27895;104261;24382;2224;8372;10914;26627;24463;87591;22116;21608;20704;87415;95477;24;9;20193;86693;22026;85386;21785;20250;26487;8078;20028;87782;11523;8387;10505;20062;17228;20509;27651;21631;22079;21936;16902;124092;24514;20248;22164;147;14917;26297;11001;33690;24404;141;17845;134;11009;85032;211;22762;7401;20930;91517;20179;20474;21551;3931;87747;20158;34378;21935;115332;87512;34444;21245;22656;8493;93797;20878;10493;16675;14910;84713;3326;21813;20192;8613;58;34377;85304;4787;21571;84746;8066;34446;20131;26414;7002;34356;119226;8710;21181;87771;111541;87578;24518;21443;84680;21179;84688;24924;121943;21250;20085;24308;20183;104244;24391;22053;20249;119236;20316;13817;11392;3141;124053;21010;24408;2167;21205;87784;114232;113189;85599;239;123804;87797;26384;9779;22297;85193;87874;21808;16998;21841;26500;21749;20279;14846;20153;20051;87640;20750;8340;119701;115348;21764;104190;21200;223;34786;24575;21382;123931;20184;16944;87676;20729;24427;21585;87597;2676;16362;21947;3119;12389;20324;128;26467;3181;20734;20940;34439;20254;20145;104546;20335;21319;22669;34442;22081;34441;21913;121942;8031;26320;21471;3182;124137;22806;87825;26493];

chosenSetsConstituents = [chosenSet1,chosenSet2];

cutoffYear = 2014;
nameSuffixOfSet = '_';

%--------------------------------------------------------------------------
% SPECIFYING CLASSIFICATION:
% -- What is the critical-value cutoff for the specification in to TopFlop?
TailSize = 0.1; % Each Tail has this size (i.e. 0.1: 10% in the upper and 10% in the lower tail.
criticalValue = norminv(1-TailSize,0,1);

%==========================================================================


% I collect all the parameters to be able to hand them to functions so they
% can use them. I even export them to .csv for later use.

% From the Parameters, I can obtain the number of consecutive months
% needed:
unassignedDays = rem(noDailyObs,minTradingDays);
noConsMonths = (noDailyObs-unassignedDays)/minTradingDays ...
    + ceil(unassignedDays/20 + noWeeklyObs/4) + ... Devide by 20 because weeks are always 4 at 5 days per month
    + noMonthlyObs ...
    + (futureUnit == 'm')*futureStep ...
    + ceil((futureUnit == 'w')*futureStep/4) ...
    + ceil((futureUnit == 'd')*futureStep/minTradingDays);

paramsData = [DATA_SAVE_PATH, STORE_DOT_MAT, NR_DOWNLOADED_FILES, PACKS_PER_OUTPUT_TABLE, minTradingDays, noDailyObs, noWeeklyObs, noMonthlyObs, ...
    {futureUnit}, futureStep, noConsMonths, date, minPrice, maxGR, maxNonVariationDays, cutoffYear, criticalValue, ...
    nameSuffixOfSet, requiredLengthOfStretch, requiredMinimalEndDateOfStretch, testSetSize, nrRandomSets, chosenSetsConstituents];
paramsNames = {'DATA_SAVE_PATH' 'STORE_DOT_MAT' 'NR_DOWNLOADED_FILES' 'PACKS_PER_OUTPUT_TABLE' 'minTradingDays' 'noDailyObs' 'noWeeklyObs' ...
    'noMonthlyObs' 'futureUnit' 'futureStep' 'noConsMonths' 'date' 'minPrice' 'maxGR' 'maxNonVariationDays' ...
    'cutoffYear' 'criticalValue' 'nameSuffixOfSet' 'requiredLengthOfStretch' 'requiredMinimalEndDateOfStretch' 'testSetSize' 'nrRandomSets' 'chosenSetsConstituents'};
params = array2table(paramsData,'VariableNames',paramsNames);

% Since the function 'getVarNamesFromParams' uses the params as input, it
% is easiest to use it right here and create the varNames, and then save
% them as part of the params. Then, they are accesible at all times.
varNames = getVarNamesFromParams(params);
varNames = array2table({varNames},'VariableNames',{'VarNames'});
params = horzcat(params, varNames);
save('Matlab/params.mat','params');

% I can now try to call the different scripts from right here. This allows
% for a lot of freedom: I run this script and end up with a finished
% Dataset! 
% If not all steps are needed, feel free to comment out any script-calls.
tic
disp('Starting to repackage the raw date according to the parametrization...')
run('A2_Import.m')
toc
disp('Sorting packages by months and years to get relative performance measures...')
run('A3_CreateSets.m')
toc
disp('Computing relative performance measures...')
run('A4_ComputeReturns.m')
toc
disp('Writing the dataset to file...')
run('A5_CreateCSV.m')
toc